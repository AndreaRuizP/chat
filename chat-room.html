<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Talk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/public/icon.png">
    <link rel="stylesheet" href="/style.css">
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen">
    <!-- Navbar -->
    <nav class="Navbar bg-gray-900 shadow-lg fixed top-0 left-0 right-0 z-50 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <a href="/index.html">
                        <img class="logo w-10 h-10" src="/public/logo.png" alt="Talk Logo">
                    </a>
                    <div>
                        <h1 class="text-white font-bold text-lg" id="roomName">General</h1>
                        <p class="text-gray-400 text-xs" id="roomMembers">0 miembros</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleMembersPanel()" class="text-gray-400 hover:text-white transition">
                        <i class="fas fa-users text-xl"></i>
                    </button>
                    <div id="userAvatar" class="w-10 h-10 bg-gradient-to-br from-[#F47ED5] to-[#CC2D9E] rounded-full flex items-center justify-center text-white font-bold">
                        ?
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex h-screen pt-16">
        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-comments text-5xl mb-3 text-gray-700"></i>
                    <p>No hay mensajes a煤n. 隆S茅 el primero en escribir!</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-4 py-2 text-gray-400 text-sm">
                <i class="fas fa-ellipsis-h animate-pulse"></i>
                <span id="typingUsers"></span>
            </div>

            <!-- Input Area -->
            <div class="bg-gray-900 border-t border-gray-800 p-4">
                <div class="flex items-center gap-2">
                    <!-- Attach Button -->
                    <div class="relative">
                        <button onclick="toggleAttachMenu()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-[#E84DBF] transition rounded-full hover:bg-gray-800">
                            <i class="fas fa-paperclip text-xl"></i>
                        </button>
                        
                        <!-- Attach Menu -->
                        <div id="attachMenu" class="hidden absolute bottom-full left-0 mb-2 bg-gray-800 rounded-xl shadow-2xl border border-gray-700 p-2 w-48">
                            <label class="flex items-center gap-3 px-3 py-2 hover:bg-gray-700 rounded-lg cursor-pointer transition">
                                <i class="fas fa-image text-blue-400"></i>
                                <span class="text-white text-sm">Imagen</span>
                                <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleFileUpload(this, 'image')">
                            </label>
                            <label class="flex items-center gap-3 px-3 py-2 hover:bg-gray-700 rounded-lg cursor-pointer transition">
                                <i class="fas fa-video text-purple-400"></i>
                                <span class="text-white text-sm">Video</span>
                                <input type="file" id="videoInput" accept="video/*" class="hidden" onchange="handleFileUpload(this, 'video')">
                            </label>
                            <label class="flex items-center gap-3 px-3 py-2 hover:bg-gray-700 rounded-lg cursor-pointer transition">
                                <i class="fas fa-microphone text-red-400"></i>
                                <span class="text-white text-sm">Audio</span>
                                <input type="file" id="audioInput" accept="audio/*" class="hidden" onchange="handleFileUpload(this, 'audio')">
                            </label>
                            <button onclick="startRecording()" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-700 rounded-lg transition">
                                <i class="fas fa-circle text-red-500"></i>
                                <span class="text-white text-sm">Grabar Audio</span>
                            </button>
                        </div>
                    </div>

                    <!-- Message Input -->
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Escribe un mensaje..." 
                        class="flex-1 px-4 py-3 bg-gray-800 text-white rounded-full focus:outline-none focus:ring-2 focus:ring-[#E84DBF]"
                        onkeypress="handleKeyPress(event)"
                        oninput="handleTyping()"
                    >

                    <!-- Send Button -->
                    <button onclick="sendMessage()" class="w-12 h-12 bg-gradient-to-r from-[#E84DBF] to-[#CC2D9E] text-white rounded-full hover:shadow-lg transition flex items-center justify-center">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Members Panel -->
        <div id="membersPanel" class="hidden w-80 bg-gray-900 border-l border-gray-800 overflow-y-auto">
            <div class="p-4">
                <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-users text-[#E84DBF]"></i>
                    Miembros
                    <span id="memberCount" class="text-gray-400 text-sm">0</span>
                </h3>
                <div class="gradient-bar mb-4"></div>
                
                <div id="membersList" class="space-y-2">
                    <!-- Members will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recording Modal -->
    <div id="recordingModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-gray-800">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto bg-red-500 rounded-full flex items-center justify-center mb-4 animate-pulse">
                    <i class="fas fa-microphone text-white text-3xl"></i>
                </div>
                <h3 class="text-white font-bold text-xl mb-2">Grabando Audio</h3>
                <p class="text-gray-400 mb-4"><span id="recordingTime">0:00</span></p>
                <div class="flex gap-2">
                    <button onclick="cancelRecording()" class="flex-1 py-2.5 bg-gray-800 text-white font-semibold rounded-xl hover:bg-gray-700 transition">
                        Cancelar
                    </button>
                    <button onclick="stopRecording()" class="flex-1 py-2.5 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">
                        Detener
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-4 rounded-xl shadow-2xl border border-gray-700 z-[110] animate-slideUp">
        <div class="flex items-center gap-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-400 text-xl"></i>
            <p id="toastMessage" class="font-semibold"></p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000';
        
        let currentUser = null;
        let currentRoom = null;
        let ws = null;
        let typingTimeout = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingInterval = null;
        let recordingSeconds = 0;

        async function init() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/pages/login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room') || 1;

            try {
                const userResponse = await fetch(`${API_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!userResponse.ok) {
                    window.location.href = '/pages/login.html';
                    return;
                }
                
                currentUser = await userResponse.json();
                document.getElementById('userAvatar').textContent = currentUser.avatar || currentUser.username.charAt(0).toUpperCase();

                const roomResponse = await fetch(`${API_URL}/rooms/${roomId}`);
                currentRoom = await roomResponse.json();
                
                document.getElementById('roomName').textContent = currentRoom.name;
                document.getElementById('roomMembers').textContent = `${currentRoom.members} miembros`;

                await joinRoom(roomId);
                await loadMessages(roomId);
                await loadMembers(roomId);
                connectWebSocket(roomId, token);

            } catch (error) {
                console.error('Error:', error);
                showToast('Error al cargar el chat', 'error');
            }
        }

        function connectWebSocket(roomId, token) {
            ws = new WebSocket(`${WS_URL}/ws/room/${roomId}?token=${token}`);

            ws.onopen = () => {
                console.log('WebSocket conectado');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
                setTimeout(() => connectWebSocket(roomId, token), 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'new_message':
                    addMessageToChat(data);
                    break;
                case 'user_joined':
                    showSystemMessage(`${data.username} se uni贸 a la sala`, 'join');
                    loadMembers(currentRoom.id);
                    break;
                case 'user_left':
                    showSystemMessage(`${data.username} sali贸 de la sala`, 'leave');
                    loadMembers(currentRoom.id);
                    break;
                case 'user_connected':
                    console.log(`${data.username} se conect贸`);
                    loadMembers(currentRoom.id);
                    break;
                case 'user_disconnected':
                    console.log(`${data.username} se desconect贸`);
                    break;
                case 'typing':
                    handleTypingIndicator(data);
                    break;
            }
        }

        async function loadMessages(roomId) {
            try {
                const response = await fetch(`${API_URL}/rooms/${roomId}/messages`);
                const messages = await response.json();
                
                const container = document.getElementById('messagesContainer');
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-comments text-5xl mb-3 text-gray-700"></i>
                            <p>No hay mensajes a煤n. 隆S茅 el primero en escribir!</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    messages.forEach(msg => addMessageToChat(msg, false));
                }
                
                scrollToBottom();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function addMessageToChat(message, shouldScroll = true) {
            const container = document.getElementById('messagesContainer');
            
            const emptyState = container.querySelector('.text-center');
            if (emptyState) emptyState.remove();

            const isOwn = currentUser && message.sender_id === currentUser.id;
            const messageEl = document.createElement('div');
            messageEl.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} animate-fadeIn`;
            
            let messageContent = '';
            
            if (message.message_type === 'text') {
                messageContent = `<p class="text-white break-words">${escapeHtml(message.content)}</p>`;
            } else if (message.message_type === 'image') {
                messageContent = `
                    <img src="${API_URL}${message.file_url}" alt="Imagen" class="max-w-xs rounded-xl cursor-pointer hover:opacity-90 transition" onclick="window.open('${API_URL}${message.file_url}', '_blank')">
                    <p class="text-gray-300 text-sm mt-1">${escapeHtml(message.content)}</p>
                `;
            } else if (message.message_type === 'video') {
                messageContent = `
                    <video controls class="max-w-xs rounded-xl">
                        <source src="${API_URL}${message.file_url}" type="video/mp4">
                    </video>
                    <p class="text-gray-300 text-sm mt-1">${escapeHtml(message.content)}</p>
                `;
            } else if (message.message_type === 'audio') {
                messageContent = `
                    <audio controls class="w-64">
                        <source src="${API_URL}${message.file_url}" type="audio/mpeg">
                    </audio>
                    <p class="text-gray-300 text-sm mt-1">${escapeHtml(message.content)}</p>
                `;
            }

            messageEl.innerHTML = `
                <div class="flex gap-2 max-w-lg ${isOwn ? 'flex-row-reverse' : ''}">
                    ${!isOwn ? `
                    <div class="w-8 h-8 bg-gradient-to-br from-[#F47ED5] to-[#CC2D9E] rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                        ${message.sender_avatar || message.sender_username.charAt(0).toUpperCase()}
                    </div>
                    ` : ''}
                    <div>
                        ${!isOwn ? `<p class="text-xs text-gray-400 mb-1 ml-1">${message.sender_username}</p>` : ''}
                        <div class="px-4 py-2 rounded-2xl ${isOwn ? 'bg-gradient-to-r from-[#E84DBF] to-[#CC2D9E]' : 'bg-gray-800'}">
                            ${messageContent}
                        </div>
                        <p class="text-xs text-gray-500 mt-1 ${isOwn ? 'text-right' : 'ml-1'}">
                            ${formatTime(message.created_at)}
                        </p>
                    </div>
                </div>
            `;
            
            container.appendChild(messageEl);
            
            if (shouldScroll) {
                scrollToBottom();
            }
        }

        function showSystemMessage(message, type) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = 'flex justify-center animate-fadeIn';
            
            const icon = type === 'join' ? '' : '';
            const bgColor = type === 'join' ? 'bg-green-900' : 'bg-red-900';
            
            messageEl.innerHTML = `
                <div class="px-4 py-2 ${bgColor} bg-opacity-30 rounded-full text-sm text-gray-300">
                    ${icon} ${message}
                </div>
            `;
            
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !ws) return;
            
            ws.send(JSON.stringify({
                type: 'message',
                content: content
            }));
            
            input.value = '';
            stopTyping();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleTyping() {
            if (!ws) return;
            
            ws.send(JSON.stringify({
                type: 'typing',
                is_typing: true
            }));
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(stopTyping, 1000);
        }

        function stopTyping() {
            if (!ws) return;
            
            ws.send(JSON.stringify({
                type: 'typing',
                is_typing: false
            }));
        }

        function handleTypingIndicator(data) {
            const indicator = document.getElementById('typingIndicator');
            const usersSpan = document.getElementById('typingUsers');
            
            if (data.is_typing && data.username !== currentUser.username) {
                usersSpan.textContent = `${data.username} est谩 escribiendo...`;
                indicator.classList.remove('hidden');
                
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 3000);
            } else {
                indicator.classList.add('hidden');
            }
        }

        function toggleAttachMenu() {
            const menu = document.getElementById('attachMenu');
            menu.classList.toggle('hidden');
        }

        async function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showToast('El archivo no puede superar 10MB', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('message_type', type);
            
            const token = localStorage.getItem('token');
            
            try {
                showToast('Subiendo archivo...', 'info');
                
                const response = await fetch(`${API_URL}/rooms/${currentRoom.id}/upload?message_type=${type}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    showToast('Archivo enviado', 'success');
                    input.value = '';
                    document.getElementById('attachMenu').classList.add('hidden');
                } else {
                    showToast('Error al subir archivo', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi贸n', 'error');
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await uploadAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                document.getElementById('recordingModal').classList.remove('hidden');
                document.getElementById('attachMenu').classList.add('hidden');
                
                recordingInterval = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    document.getElementById('recordingTime').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('No se pudo acceder al micr贸fono', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(recordingInterval);
                document.getElementById('recordingModal').classList.add('hidden');
            }
        }

        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                audioChunks = [];
                clearInterval(recordingInterval);
                document.getElementById('recordingModal').classList.add('hidden');
            }
        }

        async function uploadAudio(blob) {
            const formData = new FormData();
            formData.append('file', blob, 'audio.webm');
            formData.append('message_type', 'audio');
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/rooms/${currentRoom.id}/upload?message_type=audio`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    showToast('Audio enviado', 'success');
                } else {
                    showToast('Error al enviar audio', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexi贸n', 'error');
            }
        }

        async function joinRoom(roomId) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_URL}/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadMembers(roomId) {
            try {
                const response = await fetch(`${API_URL}/rooms/${roomId}/members`);
                const members = await response.json();
                
                const container = document.getElementById('membersList');
                document.getElementById('memberCount').textContent = `(${members.length})`;
                document.getElementById('roomMembers').textContent = `${members.length} miembros`;
                
                container.innerHTML = members.map(member => `
                    <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-xl hover:bg-gray-750 transition">
                        <div class="w-10 h-10 bg-gradient-to-br from-[#F47ED5] to-[#CC2D9E] rounded-full flex items-center justify-center text-white font-bold">
                            ${member.avatar || member.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1">
                            <p class="text-white font-semibold">${member.username}</p>
                            ${member.full_name ? `<p class="text-gray-400 text-xs">${member.full_name}</p>` : ''}
                        </div>
                        ${member.id === currentUser.id ? '<span class="text-xs text-[#E84DBF]">T煤</span>' : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function toggleMembersPanel() {
            document.getElementById('membersPanel').classList.toggle('hidden');
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Ahora';
            if (diff < 3600000) return `Hace ${Math.floor(diff / 60000)} min`;
            if (diff < 86400000) return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            msg.textContent = message;
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-green-400 text-xl';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle text-red-400 text-xl';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle text-blue-400 text-xl';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        document.addEventListener('click', function(e) {
            const attachMenu = document.getElementById('attachMenu');
            if (!e.target.closest('.relative') && !attachMenu.classList.contains('hidden')) {
                attachMenu.classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
        
        #messagesContainer::-webkit-scrollbar {
            width: 8px;
        }
        #messagesContainer::-webkit-scrollbar-track {
            background: #1f2937;
        }
        #messagesContainer::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        #messagesContainer::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</body>
</html>