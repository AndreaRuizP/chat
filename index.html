<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chat en Tiempo Real</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- WebSocket (Node.js server) -->
    <script>
        let ws = new WebSocket("ws://localhost:3000");

        ws.onmessage = (event) => {
            let data = JSON.parse(event.data);
            addMessageToChat(data.username, data.message);
        };

        function addMessageToChat(username, message) {
            const chat = document.getElementById("chat");
            const msg = document.createElement("div");

            msg.className = "p-2 bg-blue-100 rounded mb-2";
            msg.textContent = username + ": " + message;

            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendMessage() {
            const username = document.getElementById("username").value;
            const message = document.getElementById("message").value;

            if (!username || !message) return;

            ws.send(JSON.stringify({ username, message }));

            // Guardar mensaje en FastAPI
            await fetch("http://127.0.0.1:8000/messages?username=" +
                username + "&message=" + message, {
                method: "POST"
            });

            document.getElementById("message").value = "";
        }

        // Cargar historial al iniciar
        window.onload = async () => {
            let res = await fetch("http://127.0.0.1:8000/messages");
            let messages = await res.json();

            messages.forEach(m => {
                addMessageToChat(m.username, m.message);
            });
        };
    </script>
</head>

<body class="bg-gray-100 p-6">

<div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4 text-center">Chat Web</h1>

    <div class="mb-4">
        <input id="username" type="text" placeholder="Tu nombre"
               class="w-full p-2 border rounded">
    </div>

    <div id="chat"
         class="h-64 overflow-y-auto border p-2 mb-4 bg-gray-50 rounded"></div>

    <div class="flex gap-2">
        <input id="message" type="text" placeholder="Mensaje"
               class="flex-1 p-2 border rounded">

        <button onclick="sendMessage()"
                class="bg-blue-600 text-white px-4 rounded">
            Enviar
        </button>
    </div>
</div>

</body>
</html>
